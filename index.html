<script>
  async function fileToBase64(file) {
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.readAsDataURL(file);
      reader.onload = () => {
        // Elimina encabezado "data:image/jpeg;base64,"
        const base64Data = reader.result.split(',')[1];
        resolve(base64Data);
      };
      reader.onerror = error => reject(error);
    });
  }

  document.getElementById('generateReport').addEventListener('click', async () => {
    const files = document.getElementById('imageUpload').files;
    const reportDiv = document.getElementById('report');

    if (files.length === 0) {
      reportDiv.innerHTML = '<p class="text-red-600">Por favor, sube al menos una imagen.</p>';
      return;
    }

    reportDiv.innerHTML = '<p class="text-blue-600">Generando informe, por favor espera...</p>';

    try {
      const parts = [];

      parts.push({ text: "Analiza las siguientes imágenes de un medidor eléctrico y genera un informe detallado sobre el tipo de medidor, cantidad de cables conectados, posibles anomalías visuales y cualquier observación relevante." });

      for (let file of files) {
        const base64Image = await fileToBase64(file);
        parts.push({
          inlineData: {
            mimeType: file.type,
            data: base64Image
          }
        });
      }

      const payloadToBackend = {
        contents: [
          {
            role: "user",
            parts: parts
          }
        ]
      };

      console.log("Payload enviado al backend:", JSON.stringify(payloadToBackend, null, 2));

      const response = await fetch('https://lector-yaye.onrender.com/api/gemini-report', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(payloadToBackend)
      });

      const data = await response.json();

      if (!response.ok) {
        throw new Error(`Error ${response.status}: ${data.detail || JSON.stringify(data)}`);
      }

      reportDiv.innerHTML = `
        <h3 class="text-lg font-bold text-purple-700 mb-2">Informe Generado</h3>
        <pre class="bg-gray-100 p-3 rounded border border-gray-300 whitespace-pre-wrap">${data.report}</pre>
      `;
    } catch (error) {
      console.error(error);
      reportDiv.innerHTML = `<pre class="bg-red-100 text-red-800 p-3 rounded border border-red-400 whitespace-pre-wrap"><strong>¡Error!</strong> ${error.message}</pre>`;
    }
  });
</script>
