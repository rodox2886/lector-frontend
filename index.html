<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Lector de Medidores Gemini</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-purple-50 text-gray-800 font-sans">
  <div class="max-w-3xl mx-auto p-6">
    <h1 class="text-3xl font-bold text-purple-700 mb-6 text-center">Lector de Medidores Gemini</h1>

    <!-- Paso 1: Sube o Captura Fotos del Medidor -->
    <div class="bg-white rounded-xl shadow-md p-4 mb-6">
      <h2 class="text-lg font-semibold text-purple-700 mb-2">Paso 1: Sube o Captura Fotos del Medidor</h2>
      <!-- Permite la selecci칩n de m칰ltiples archivos de imagen -->
      <input type="file" id="fileInput" class="mb-2" accept="image/*" multiple />
      <div id="preview" class="mt-2 flex flex-wrap gap-2">
        <!-- Las miniaturas de las im치genes se mostrar치n aqu칤 -->
      </div>
    </div>

    <!-- Paso 2: Generar Informe con Gemini -->
    <div class="bg-white rounded-xl shadow-md p-4 mb-6">
      <h2 class="text-lg font-semibold text-purple-700 mb-2">Paso 2: Generar Informe con Gemini</h2>
      <button onclick="uploadImages()" class="bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600 transition duration-300">Generar Informe</button>
    </div>

    <!-- Resultado e Informaci칩n -->
    <div class="bg-white rounded-xl shadow-md p-4">
      <h2 class="text-lg font-semibold text-purple-700 mb-2">Informe Generado</h2>
      <!-- Contenedor para mostrar mensajes de estado y el informe -->
      <div id="infoBox" class="bg-gray-50 p-3 rounded-lg text-sm leading-relaxed whitespace-pre-wrap text-gray-800">Esperando im치genes...</div>
      <!-- Indicador de carga -->
      <div id="loadingIndicator" class="hidden mt-4 text-center text-purple-600 font-semibold">
        Cargando y analizando im치genes, por favor espera...
      </div>
    </div>
  </div>

  <script>
    const fileInput = document.getElementById("fileInput");
    const infoBox = document.getElementById("infoBox");
    const preview = document.getElementById("preview");
    const loadingIndicator = document.getElementById("loadingIndicator");
    let selectedFiles = []; // Array para almacenar m칰ltiples archivos seleccionados

    // Event listener para cuando cambian los archivos seleccionados
    fileInput.addEventListener("change", () => {
      selectedFiles = Array.from(fileInput.files); // Convertir FileList a Array
      preview.innerHTML = ''; // Limpiar previsualizaciones anteriores
      infoBox.textContent = `Se han cargado ${selectedFiles.length} imagen(es). Lista(s) para enviar.`;

      // Mostrar previsualizaciones de todas las im치genes
      selectedFiles.forEach(file => {
        const imgURL = URL.createObjectURL(file);
        preview.innerHTML += `<img src="${imgURL}" class="h-24 w-24 object-cover rounded-md border-2 border-purple-300 shadow-sm" alt="Preview de imagen" />`;
      });
    });

    // Funci칩n para subir todas las im치genes seleccionadas
    async function uploadImages() {
      if (selectedFiles.length === 0) {
        infoBox.textContent = "Por favor, selecciona al menos una imagen.";
        return;
      }

      // Mostrar indicador de carga
      loadingIndicator.classList.remove('hidden');
      infoBox.textContent = ''; // Limpiar mensaje anterior

      const formData = new FormData();
      // Anexar cada archivo a FormData con la misma clave 'files'
      selectedFiles.forEach(file => {
        formData.append("files", file);
      });

      try {
        // Realizar la solicitud POST al backend
        const res = await fetch("https://lector-yaye.onrender.com/api/gemini-report", {
          method: "POST",
          body: formData,
        });

        const data = await res.json();

        // Ocultar indicador de carga
        loadingIndicator.classList.add('hidden');

        // Mostrar el informe o el mensaje de error
        if (data.message) {
          // Si data.message es un objeto (JSON estructurado), formatearlo.
          // Si es una cadena (posiblemente un error), mostrarla directamente.
          if (typeof data.message === 'object' && data.message !== null) {
            infoBox.innerHTML = formatStructuredReport(data.message, data.filenames, data.total_size_kb);
          } else {
            // Esto maneja errores devueltos como una cadena en 'message'
            infoBox.textContent = "Error al generar el informe: " + data.message;
          }
        } else if (data.error) {
            infoBox.textContent = "Error: " + data.error;
        } else {
          infoBox.textContent = "Error al generar el informe: Mensaje desconocido o estructura de datos inesperada.";
        }
      } catch (err) {
        // Ocultar indicador de carga
        loadingIndicator.classList.add('hidden');
        infoBox.textContent = "춰Error de red o servidor! " + err.message;
      }
    }

    // Nueva funci칩n para formatear el informe estructurado (JSON)
    function formatStructuredReport(reportData, filenames, totalSizeKb) {
      let htmlContent = `
        <div class="mb-4">
          <p><span class="font-semibold">游늯 Archivos analizados:</span> ${filenames.join(', ')}</p>
          <p><span class="font-semibold">游닍 Tama침o total:</span> ${totalSizeKb} KB</p>
        </div>
      `;

      // M칩dulo: Tipo de Medidor
      if (reportData.tipoMedidor) {
        htmlContent += `
          <div class="bg-blue-50 border-l-4 border-blue-400 text-blue-800 p-3 mb-3 rounded-md">
            <h3 class="font-bold text-blue-700 mb-1">Tipo de Medidor</h3>
            <p>${reportData.tipoMedidor}</p>
          </div>
        `;
      }

      // M칩dulo: Cantidad de Cables Conectados
      if (reportData.cablesConectados !== undefined) {
        htmlContent += `
          <div class="bg-green-50 border-l-4 border-green-400 text-green-800 p-3 mb-3 rounded-md">
            <h3 class="font-bold text-green-700 mb-1">Cables Conectados</h3>
            <p>${reportData.cablesConectados}</p>
          </div>
        `;
      }

      // M칩dulo: Estado General Visible
      if (reportData.estadoGeneralVisible) {
        htmlContent += `
          <div class="bg-yellow-50 border-l-4 border-yellow-400 text-yellow-800 p-3 mb-3 rounded-md">
            <h3 class="font-bold text-yellow-700 mb-1">Estado General Visible</h3>
            <p>${reportData.estadoGeneralVisible}</p>
          </div>
        `;
      }

      // M칩dulo: Anomal칤as Detectadas
      if (reportData.anomaliasDetectadas && reportData.anomaliasDetectadas.length > 0) {
        htmlContent += `
          <div class="bg-red-50 border-l-4 border-red-400 text-red-800 p-3 mb-3 rounded-md">
            <h3 class="font-bold text-red-700 mb-1">Anomal칤as Detectadas</h3>
            <ul class="list-disc list-inside">
              ${reportData.anomaliasDetectadas.map(anomaly => `<li>${anomaly}</li>`).join('')}
            </ul>
          </div>
        `;
      } else if (reportData.anomaliasDetectadas && reportData.anomaliasDetectadas.length === 0) {
        htmlContent += `
          <div class="bg-green-50 border-l-4 border-green-400 text-green-800 p-3 mb-3 rounded-md">
            <h3 class="font-bold text-green-700 mb-1">Anomal칤as Detectadas</h3>
            <p>No se detectaron anomal칤as visibles.</p>
          </div>
        `;
      }


      // M칩dulo: Conclusi칩n General
      if (reportData.conclusionGeneral) {
        htmlContent += `
          <div class="bg-purple-50 border-l-4 border-purple-400 text-purple-800 p-3 mb-3 rounded-md">
            <h3 class="font-bold text-purple-700 mb-1">Conclusi칩n General</h3>
            <p>${reportData.conclusionGeneral}</p>
          </div>
        `;
      }

      return htmlContent;
    }

    // Funci칩n original de formateo (mantenida por si acaso se recibe un mensaje no JSON)
    // Aunque con los cambios en el backend, data.message siempre deber칤a ser JSON o un error espec칤fico.
    function formatReport(data) {
      // Esta funci칩n ya no deber칤a ser llamada con un objeto JSON como 'message'
      // Se mantiene para compatibilidad con posibles errores no estructurados.
      const clean = data.message.replace(/\\n/g, "\n").replace(/\*\*/g, "").replace(/#/g, "");
      return `游늯 Archivos analizados: ${data.filenames.join(', ')}
游닍 Tama침o total: ${data.total_size_kb} KB

${clean}`;
    }
  </script>
</body>
</html>

