<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Lector de Medidores Gemini</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-purple-50 text-gray-800 font-sans">
  <div class="max-w-3xl mx-auto p-6">
    <h1 class="text-3xl font-bold text-purple-700 mb-6 text-center">Lector de Medidores Gemini</h1>

    <!-- Paso 1: Sube o Captura Fotos del Medidor -->
    <div class="bg-white rounded-xl shadow-md p-4 mb-6">
      <h2 class="text-lg font-semibold text-purple-700 mb-2">Paso 1: Sube o Captura Fotos del Medidor</h2>
      <!-- Permite la selecci칩n de m칰ltiples archivos de imagen -->
      <input type="file" id="fileInput" class="mb-2" accept="image/*" multiple />
      <div id="preview" class="mt-2 flex flex-wrap gap-2">
        <!-- Las miniaturas de las im치genes se mostrar치n aqu칤 -->
      </div>
    </div>

    <!-- Paso 2: Generar Informe con Gemini -->
    <div class="bg-white rounded-xl shadow-md p-4 mb-6">
      <h2 class="text-lg font-semibold text-purple-700 mb-2">Paso 2: Generar Informe con Gemini</h2>
      <button onclick="uploadImages()" class="bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600 transition duration-300">Generar Informe</button>
    </div>

    <!-- Resultado e Informaci칩n -->
    <div class="bg-white rounded-xl shadow-md p-4">
      <h2 class="text-lg font-semibold text-purple-700 mb-2">Informe Generado</h2>
      <!-- Contenedor para mostrar mensajes de estado y el informe -->
      <div id="infoBox" class="bg-gray-50 p-3 rounded-lg text-sm leading-relaxed whitespace-pre-wrap text-gray-800">Esperando im치genes...</div>
      <!-- Indicador de carga -->
      <div id="loadingIndicator" class="hidden mt-4 text-center text-purple-600 font-semibold">
        Cargando y analizando im치genes, por favor espera...
      </div>
    </div>
  </div>

  <script>
    const fileInput = document.getElementById("fileInput");
    const infoBox = document.getElementById("infoBox");
    const preview = document.getElementById("preview");
    const loadingIndicator = document.getElementById("loadingIndicator");
    let selectedFiles = []; // Array para almacenar m칰ltiples archivos seleccionados

    // Event listener para cuando cambian los archivos seleccionados
    fileInput.addEventListener("change", () => {
      selectedFiles = Array.from(fileInput.files); // Convertir FileList a Array
      preview.innerHTML = ''; // Limpiar previsualizaciones anteriores
      infoBox.textContent = `Se han cargado ${selectedFiles.length} imagen(es). Lista(s) para enviar.`;

      // Mostrar previsualizaciones de todas las im치genes
      selectedFiles.forEach(file => {
        const imgURL = URL.createObjectURL(file);
        preview.innerHTML += `<img src="${imgURL}" class="h-24 w-24 object-cover rounded-md border-2 border-purple-300 shadow-sm" alt="Preview de imagen" />`;
      });
    });

    // Funci칩n para subir todas las im치genes seleccionadas
    async function uploadImages() {
      if (selectedFiles.length === 0) {
        infoBox.textContent = "Por favor, selecciona al menos una imagen.";
        return;
      }

      // Mostrar indicador de carga
      loadingIndicator.classList.remove('hidden');
      infoBox.textContent = ''; // Limpiar mensaje anterior

      const formData = new FormData();
      // Anexar cada archivo a FormData con la misma clave 'files'
      selectedFiles.forEach(file => {
        formData.append("files", file);
      });

      try {
        // Realizar la solicitud POST al backend
        const res = await fetch("https://lector-yaye.onrender.com/api/gemini-report", {
          method: "POST",
          body: formData,
        });

        const data = await res.json();

        // Ocultar indicador de carga
        loadingIndicator.classList.add('hidden');

        // Mostrar el informe o el mensaje de error
        if (data.message) {
          infoBox.innerHTML = formatReport(data);
        } else {
          infoBox.textContent = "Error al generar el informe: " + (data.error || "Mensaje desconocido.");
        }
      } catch (err) {
        // Ocultar indicador de carga
        loadingIndicator.classList.add('hidden');
        infoBox.textContent = "춰Error de red o servidor! " + err.message;
      }
    }

    // Funci칩n para formatear el informe recibido de Gemini
    function formatReport(data) {
      // Reemplazar saltos de l칤nea y formateo de Markdown para una mejor visualizaci칩n
      const clean = data.message.replace(/\\n/g, "\n").replace(/\*\*/g, "").replace(/#/g, "");
      return `游늯 Archivos analizados: ${data.filenames.join(', ')}
游닍 Tama침o total: ${data.total_size_kb} KB

${clean}`;
    }
  </script>
</body>
</html>
